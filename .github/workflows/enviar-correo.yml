name: Enviar notificaciÃ³n por correo

on:
  issues:
    types: [opened, edited]

jobs:
  send-email:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'ðŸ“¦ Recibido') || contains(github.event.issue.labels.*.name, 'ðŸšš EnvÃ­o') || contains(github.event.issue.labels.*.name, 'âœ… Entregado')
    
    steps:
      - name: Extraer datos del Issue
        id: extract
        run: |
          # Extraer email del cuerpo del issue (JSON)
          BODY='${{ github.event.issue.body }}'
          EMAIL=$(echo $BODY | grep -o '"email":"[^"]*"' | cut -d'"' -f4)
          NOMBRE=$(echo $BODY | grep -o '"nombre":"[^"]*"' | cut -d'"' -f4)
          TRACKING="${{ github.event.issue.title }}"
          
          echo "EMAIL=$EMAIL" >> $GITHUB_ENV
          echo "NOMBRE=$NOMBRE" >> $GITHUB_ENV
          echo "TRACKING=$TRACKING" >> $GITHUB_ENV
          
          # Determinar estado
          if [[ "${{ github.event.issue.labels.*.name }}" == *"ðŸ“¦ Recibido"* ]]; then
            echo "ESTADO=recibido" >> $GITHUB_ENV
          elif [[ "${{ github.event.issue.labels.*.name }}" == *"ðŸšš EnvÃ­o"* ]]; then
            echo "ESTADO=enviado" >> $GITHUB_ENV
          elif [[ "${{ github.event.issue.labels.*.name }}" == *"âœ… Entregado"* ]]; then
            echo "ESTADO=entregado" >> $GITHUB_ENV
          fi
      
      - name: Enviar correo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: |
            ${{ env.ESTADO == 'recibido' && 'ðŸ“¦ Tu pedido ha sido recibido' ||
               env.ESTADO == 'enviado' && 'ðŸšš Tu pedido estÃ¡ en camino' ||
               env.ESTADO == 'entregado' && 'âœ… Tu pedido fue entregado' }}
          to: ${{ env.EMAIL }}
          from: Maison Lumien FacturaciÃ³n
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body { font-family: 'Inter', sans-serif; background: #f5f5f5; padding: 20px; }
                    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
                    .header { background: linear-gradient(135deg, #4F46E5, #10B981); padding: 40px; text-align: center; }
                    .header h1 { color: white; margin: 0; font-size: 28px; font-weight: 300; }
                    .content { padding: 40px; }
                    .button { display: inline-block; background: linear-gradient(135deg, #4F46E5, #3730A3); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; margin: 20px 0; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>MAISON LUMIEN</h1>
                        <p style="color: rgba(255,255,255,0.9); margin-top: 10px;">El arte de vivir con luz</p>
                    </div>
                    <div class="content">
                        <h2 style="color: #1F2937;">Hola ${{ env.NOMBRE }},</h2>
                        
                        ${{ env.ESTADO == 'recibido' && '<p>Hemos recibido tu producto en nuestras oficinas. Pronto lo enviaremos a tu direcciÃ³n.</p>' ||
                           env.ESTADO == 'enviado' && '<p>Â¡Buenas noticias! Tu producto ya fue enviado a tu direcciÃ³n.</p>' ||
                           env.ESTADO == 'entregado' && '<p>Tu producto ha sido entregado exitosamente. Esperamos que lo disfrutes.</p>' }}
                        
                        <p><strong>NÃºmero de seguimiento:</strong> ${{ env.TRACKING }}</p>
                        
                        <p>Puedes consultar el estado de tu pedido aquÃ­:</p>
                        
                        <p style="text-align: center;">
                            <a href="https://maisonlumien.github.io/maison-lumien-seguimiento/seguimiento.html?track=${{ env.TRACKING }}" class="button">
                                CONSULTAR MI PEDIDO
                            </a>
                        </p>
                        
                        <p>Â¿Tienes dudas? EscrÃ­benos por WhatsApp:</p>
                        <p style="text-align: center;">
                            <a href="https://wa.me/573024157799" style="color: #25D366; text-decoration: none;">ðŸ“± 302 415 7799</a>
                        </p>
                    </div>
                </div>
            </body>
            </html>
