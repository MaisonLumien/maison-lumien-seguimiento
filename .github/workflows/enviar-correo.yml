name: Enviar notificaci√≥n por correo

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  send-email:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'üì¶ Recibido') || 
      contains(github.event.issue.labels.*.name, 'üöö Env√≠o') || 
      contains(github.event.issue.labels.*.name, '‚úÖ Entregado')
    
    steps:
      - name: Extraer datos del Issue con Python
        id: extract
        run: |
          # Crear un archivo temporal para el body
          cat > issue_body.json << 'ISSUE_EOF'
          ${{ toJSON(github.event.issue.body) }}
          ISSUE_EOF
          
          python3 << 'PYTHON_EOF'
          import json
          import os
          import re
          
          try:
              # Leer el body del issue
              with open('issue_body.json', 'r') as f:
                  content = f.read().strip().strip('"')
              
              # Decodificar caracteres especiales
              content = bytes(content, 'utf-8').decode('unicode_escape')
              
              # Extraer datos con regex (m√°s seguro que parsear JSON completo)
              email_match = re.search(r'"email":"([^"]+)"', content)
              nombre_match = re.search(r'"nombre":"([^"]+)"', content)
              
              email = email_match.group(1) if email_match else 'stithvalle14@gmail.com'
              nombre = nombre_match.group(1) if nombre_match else 'Cliente'
              tracking = '${{ github.event.issue.title }}'
              
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write(f"EMAIL={email}\n")
                  env_file.write(f"NOMBRE={nombre}\n")
                  env_file.write(f"TRACKING={tracking}\n")
                  
                  # Determinar estado por labels
                  labels = '${{ github.event.issue.labels.*.name }}'
                  if 'üì¶ Recibido' in labels:
                      env_file.write("ESTADO=recibido\n")
                  elif 'üöö Env√≠o' in labels:
                      env_file.write("ESTADO=enviado\n")
                  elif '‚úÖ Entregado' in labels:
                      env_file.write("ESTADO=entregado\n")
                  else:
                      env_file.write("ESTADO=recibido\n")
                  
                  # Si es un comentario
                  if '${{ github.event_name }}' == 'issue_comment':
                      env_file.write("TIPO_EVENTO=comentario\n")
                      
                      # Obtener el comentario y escaparlo para JSON
                      comentario = '''${{ github.event.comment.body }}'''
                      # Escapar para JSON
                      comentario_json = json.dumps(comentario)
                      # Quitar las comillas externas
                      comentario_limpio = comentario_json[1:-1]
                      
                      # Primeros 50 caracteres para el asunto
                      comentario_corto = comentario_limpio[:50] + ('...' if len(comentario_limpio) > 50 else '')
                      
                      env_file.write(f"COMENTARIO={comentario_limpio}\n")
                      env_file.write(f"COMENTARIO_CORTO={comentario_corto}\n")
                  else:
                      env_file.write("TIPO_EVENTO=issue\n")
                      
          except Exception as e:
              print(f"Error: {e}")
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write("EMAIL=stithvalle14@gmail.com\n")
                  env_file.write("NOMBRE=Cliente\n")
                  env_file.write("TRACKING=${{ github.event.issue.title }}\n")
                  env_file.write("TIPO_EVENTO=issue\n")
                  env_file.write("ESTADO=recibido\n")
          PYTHON_EOF
      
      - name: Esperar a que GitHub Pages se actualice
        run: sleep 180
      
      - name: Enviar correo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: |
            ${{ env.TIPO_EVENTO == 'comentario' && format('üìù Actualizaci√≥n: {0}', env.COMENTARIO_CORTO) ||
               env.ESTADO == 'recibido' && 'üì¶ Tu pedido ha sido recibido' ||
               env.ESTADO == 'enviado' && 'üöö Tu pedido est√° en camino' ||
               env.ESTADO == 'entregado' && '‚úÖ Tu pedido fue entregado' }}
          to: ${{ env.EMAIL }}
          from: Maison Lumien Facturaci√≥n
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    body { font-family: 'Inter', sans-serif; background: #f5f5f5; padding: 20px; }
                    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
                    .header { background: linear-gradient(135deg, #4F46E5, #10B981); padding: 40px; text-align: center; }
                    .header h1 { color: white; margin: 0; font-size: 28px; font-weight: 300; }
                    .content { padding: 40px; }
                    .button { display: inline-block; background: linear-gradient(135deg, #4F46E5, #3730A3); color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; margin: 20px 0; }
                    .comentario { background: #f0f0f0; padding: 20px; border-radius: 8px; border-left: 4px solid #4F46E5; margin: 20px 0; white-space: pre-wrap; font-family: 'Courier New', monospace; }
                    .fecha { color: #666; font-size: 12px; margin-bottom: 5px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>MAISON LUMIEN</h1>
                        <p style="color: rgba(255,255,255,0.9); margin-top: 10px;">El arte de vivir con luz</p>
                    </div>
                    <div class="content">
                        <h2 style="color: #1F2937;">Hola ${{ env.NOMBRE }},</h2>
                        
                        ${{ env.TIPO_EVENTO == 'comentario' && 
                           '<p>Tu pedido tiene una nueva actualizaci√≥n:</p>' ||
                           env.ESTADO == 'recibido' && '<p>Hemos recibido tu producto en nuestras oficinas. Pronto lo enviaremos a tu direcci√≥n.</p>' ||
                           env.ESTADO == 'enviado' && '<p>¬°Buenas noticias! Tu producto ya fue enviado a tu direcci√≥n.</p>' ||
                           env.ESTADO == 'entregado' && '<p>Tu producto ha sido entregado exitosamente. Esperamos que lo disfrutes.</p>' }}
                        
                        ${{ env.TIPO_EVENTO == 'comentario' && 
                           format('<div class="comentario"><div class="fecha">{0}</div><p>{1}</p></div>', 
                           '${{ github.event.comment.created_at }}', env.COMENTARIO) || '' }}
                        
                        <p><strong>N√∫mero de seguimiento:</strong> ${{ env.TRACKING }}</p>
                        
                        <p>Puedes consultar el estado de tu pedido aqu√≠:</p>
                        
                        <p style="text-align: center;">
                            <a href="https://maisonlumien.github.io/maison-lumien-seguimiento/seguimiento.html?track=${{ env.TRACKING }}" class="button">
                                CONSULTAR MI PEDIDO
                            </a>
                        </p>
                        
                        <p>¬øTienes dudas? Escr√≠benos por WhatsApp:</p>
                        <p style="text-align: center;">
                            <a href="https://wa.me/573024157799" style="color: #25D366; text-decoration: none;">üì± 302 415 7799</a>
                        </p>
                    </div>
                </div>
            </body>
            </html>
